name: $(BuildDefinitionName)_$(MajorVersion).$(MinorVersion)$(Rev:.r).$(Year:yy)$(DayOfYear)

pool:
  name: Standalone
  demands:
  - DotNetFramework
  - msbuild

variables:
  BuildPlatform: 'any cpu'
  BuildConfiguration: 'Release'
  MajorVersion: '1'
  MinorVersion: '1'

steps:
- task: PowerShell@1
  displayName: 'Split Build Number'
  inputs:
    scriptType: inlineScript
    inlineScript: |
     [CmdletBinding()]
     
     $VersionRegex = "\d+\.\d+\.\d+\.\d+"
     $VersionData = [regex]::matches($Env:BUILD_BUILDNUMBER,$VersionRegex)
     $NewVersion = $VersionData[0].ToString()
     Write-Output "Version: $NewVersion"
     
     $VersArr = $NewVersion.Split(".")
     $Rev = $VersArr[2]
     $Build = $VersArr[3]
     Write-Host "##vso[task.setvariable variable=RevVersion]$Rev"
     Write-Host "##vso[task.setvariable variable=RevBuild]$Build"
     Write-Output "RevVersion: $Rev"
     Write-Output "RevBuild: $Build"

- task: DotNetCoreCLI@2
  displayName: 'Dotnet restore'
  inputs:
    command: restore
    projects: '**/*.sln'
    feedsToUse: config
    nugetConfigPath: nuget.config

- task: DotNetCoreCLI@2
  displayName: 'Dotnet build'
  inputs:
    command: build
    projects: '**/*.sln'
    arguments: >
      -c $(BuildConfiguration)
      /p:Version=$(MajorVersion).$(MinorVersion).$(RevVersion).$(RevBuild)
      /p:AssemblyVersion=$(MajorVersion).$(MinorVersion).$(RevVersion).$(RevBuild)
      /p:FileVersion=$(MajorVersion).$(MinorVersion).$(RevVersion).$(RevBuild)
      /p:PackageVersion=$(MajorVersion).$(MinorVersion).$(RevVersion)

- task: CopyFiles@2
  displayName: 'Copy binaries to BuildOutput'
  inputs:
    SourceFolder: '.\output'
    Contents: |
     bin\**
     packages\**
    TargetFolder: '$(ReleaseOutputDir)\$(Build.BuildNumber)'

- task: CmdLine@1
  displayName: 'Copy to StandalonePackages feed'
  inputs:
    filename: '$(BuildToolsDir)\Nuget\nuget.exe'
    arguments: 'push "$(build.sourcesDirectory)\output\packages\*.nupkg" -Source "https://fstfp01/FinstarMainCollection/Standalone/_packaging/StandalonePackages/nuget/v3/index.json" -ApiKey "Finstar-Standalone" -NonInteractive -SkipDuplicate'
  continueOnError: true