name: $(BuildDefinitionName)_$(MajorVersion).$(MinorVersion)$(Rev:.r).$(Year:yy)$(DayOfYear)

pool:
  name: Standalone
  demands:
  - DotNetFramework
  - msbuild

variables:
- group: Build Basics
- name: BuildPlatform
  value: 'any cpu'
- name: BuildConfiguration
  value: 'Release'
- name: MajorVersion
  value: '1'
- name: MinorVersion
  value: '1'
- name: projects
  value: 'DatabaseMigrationGenerator/DatabaseMigrationGenerator.csproj'

steps:
- task: PowerShell@1
  displayName: 'Split Build Number'
  inputs:
    scriptType: inlineScript
    inlineScript: |
     [CmdletBinding()]
     
     $VersionRegex = "\d+\.\d+\.\d+\.\d+"
     $VersionData = [regex]::matches($Env:BUILD_BUILDNUMBER,$VersionRegex)
     $NewVersion = $VersionData[0].ToString()
     Write-Output "Version: $NewVersion"
     
     $VersArr = $NewVersion.Split(".")
     $Rev = $VersArr[2]
     $Build = $VersArr[3]
     Write-Host "##vso[task.setvariable variable=RevVersion]$Rev"
     Write-Host "##vso[task.setvariable variable=RevBuild]$Build"
     Write-Output "RevVersion: $Rev"
     Write-Output "RevBuild: $Build"

- task: DotNetCoreCLI@2
  displayName: 'Dotnet restore'
  inputs:
    command: restore
    projects: '$(projects)'
    feedsToUse: config
    nugetConfigPath: nuget.config

- task: DotNetCoreCLI@2
  displayName: 'Dotnet build'
  inputs:
    command: build
    projects: '$(projects)'
    arguments: >
      -c $(BuildConfiguration)
      /p:Version=$(MajorVersion).$(MinorVersion).$(RevVersion).$(RevBuild)
      /p:AssemblyVersion=$(MajorVersion).$(MinorVersion).$(RevVersion).$(RevBuild)
      /p:FileVersion=$(MajorVersion).$(MinorVersion).$(RevVersion).$(RevBuild)

- task: DotNetCoreCLI@2
  displayName: 'Dotnet pack'
  inputs:
    command: pack
    projects: '$(projects)'
    arguments: >
      -c $(BuildConfiguration)
      /p:Version=$(MajorVersion).$(MinorVersion).$(RevVersion)
    nobuild: true
               
- task: DotNetCoreCLI@2
  displayName: 'Push'
  inputs:
    command: 'push'
    packagesToPush: '$(Build.ArtifactStagingDirectory)/**/*.nupkg;!$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg'
    nuGetFeedType: 'external'
    publishFeedCredentials: 'StandalonePackages'